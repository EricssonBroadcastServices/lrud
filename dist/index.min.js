"use strict";var Get=function(t,e){return e?(e=e.split(".")).reduce(function(t,e){return t&&t[e]?t[e]:null},t):t},Set=function(i,t,n){var r=t.split(".");return r.forEach(function(t,e){e===r.length-1&&(i[t]=n),null==i[t]&&(isNaN(r[e+1])?i[t]={}:i[t]=[]),i=i[t]}),i};function mitt(n){return n=n||Object.create(null),{on:function(t,e){(n[t]||(n[t]=[])).push(e)},off:function(t,e){n[t]&&n[t].splice(n[t].indexOf(e)>>>0,1)},emit:function(e,i){(n[e]||[]).slice().map(function(t){t(i)}),(n["*"]||[]).slice().map(function(t){t(e,i)})}}}var left="LEFT",right="RIGHT",up="UP",down="DOWN",enter="ENTER",KeyCodes={map:{LEFT:left,RIGHT:right,UP:up,DOWN:down,ENTER:enter},codes:{4:left,21:left,37:left,214:left,205:left,218:left,5:right,22:right,39:right,213:right,206:right,217:right,29460:up,19:up,38:up,211:up,203:up,215:up,29461:down,20:down,40:down,212:down,204:down,216:down,29443:enter,13:enter,67:enter,32:enter,23:enter,195:enter}},Closest=function(t,i){return t.reduce(function(t,e){return Math.abs(e-i)<Math.abs(t-i)?e:t})},isFocusable=function(t){return!(!t.selectAction&&!t.isFocusable)},getDirectionForKeyCode=function(t){var e=KeyCodes.codes[t];return e?e.toUpperCase():null},Lrud=function(){function t(){this.tree={},this.nodePathList=[],this.focusableNodePathList=[],this.rootNodeId=null,this.currentFocusNodeId=null,this.currentFocusNodeIndex=null,this.currentFocusNodeIndexRange=null,this.isIndexAlignMode=!1,this.emitter=new mitt,this.overrides={}}return t.prototype.isDirectionAndOrientationMatching=function(t,e){return!(!t||!e)&&(t=t.toUpperCase(),"*"===(e=e.toUpperCase())||"VERTICAL"===t&&("UP"===e||"DOWN"===e)||"HORIZONTAL"===t&&("LEFT"===e||"RIGHT"===e))},t.prototype.on=function(t,e){this.emitter.on(t,e)},t.prototype.getRootNode=function(){var t=this.getNode(this.rootNodeId);if(!t)throw new Error("no root node");return t},t.prototype.getPathForNodeId=function(e){return e===this.rootNodeId?this.rootNodeId:this.nodePathList.find(function(t){return t.endsWith("."+e)})},t.prototype.registerNode=function(t,e){if(void 0===e&&(e={}),e.id||(e.id=t),Object.keys(this.tree).length<=0)return this.rootNodeId=t,this.tree[t]=e,this.nodePathList.push(t),this;if(null==e.parent&&t!==this.rootNodeId&&(e.parent=this.rootNodeId),null==this.nodePathList.find(function(t){return t.includes(e.parent+".children")})){var i=this.getPathForNodeId(e.parent);Set(this.tree,i+".activeChild",t)}if(!e.index){var n=this.getNode(e.parent).children;e.index=n?Object.keys(n).length+1:1}var r=this.nodePathList.find(function(t){return t.endsWith(e.parent)})+".children."+t;return Set(this.tree,r,e),this.nodePathList.push(r),isFocusable(e)&&this.focusableNodePathList.push(r),this},t.prototype.unregisterNode=function(e){var t=this.getPathForNodeId(e);if(t){var i=Get(this.tree,t),n=this.getNode(i.parent);if(delete n.children[e],this.nodePathList.splice(this.nodePathList.indexOf(t),1),this.nodePathList=this.nodePathList.filter(function(t){return!t.includes("."+e)}),this.focusableNodePathList=this.focusableNodePathList.filter(function(t){return!t.includes("."+e)}),n.activeChild&&n.activeChild===e){delete n.activeChild;var r=this.climbUp(n,"*"),o=this.getPrevChild(r),d=this.digDown(o);this.assignFocus(d.id)}return this._reindexChildrenOfNode(n),Set(this.tree,this.getPathForNodeId(n.id),n),this.emitter.emit("blur",i),this}},t.prototype.registerOverride=function(t,e){if(!t)throw new Error("need an id to register an override");return this.overrides[t]=e,this},t.prototype.unregisterOverride=function(t){return delete this.overrides[t],this},t.prototype.getNode=function(t){return Get(this.tree,this.getPathForNodeId(t))},t.prototype.pickNode=function(t){var e=this.getNode(t);if(e)return this.unregisterNode(t),e},t.prototype._isNodeInFocusableNodePathList=function(e){var i=this;return this.focusableNodePathList.some(function(t){return!!t.includes("."+e.id+".")||!(e.id!==i.rootNodeId||!t.includes(e.id+"."))})},t.prototype.climbUp=function(i,n){var r=this;if(!i)return null;var t=Object.keys(this.overrides).find(function(t){var e=r.overrides[t];return e.id===i.id&&e.direction.toUpperCase()===n.toUpperCase()});if(t)return this.getNode(this.overrides[t].target);if(isFocusable(i))return this.climbUp(this.getNode(i.parent),n);if(!this._isNodeInFocusableNodePathList(i))return this.climbUp(this.getNode(i.parent),n);if(!this.isDirectionAndOrientationMatching(i.orientation,n))return this.climbUp(this.getNode(i.parent),n);var e=this.getNextChildInDirection(i,n);if(!e)return i;var o=e&&e.id===i.activeChild,d=isFocusable(this.getNode(i.activeChild)),s=this._isNodeInFocusableNodePathList(i);return o&&(d||s)?this.climbUp(this.getNode(i.parent),n):i},t.prototype.digDown=function(t){if(isFocusable(t))return t;var e=this.getNode(t.parent);if(this.isIndexAlignMode&&("vertical"!==t.orientation||"vertical"!==e.orientation)){var i=this._findChildWithMatchingIndexRange(t,this.currentFocusNodeIndex);i||(i=this._findChildWithClosestIndex(t,this.currentFocusNodeIndex,this.currentFocusNodeIndexRange)),i&&(t.activeChild=i.id)}t.activeChild||(t.activeChild=this.getNodeFirstChild(t).id);var n=this.getNode(t.activeChild);return isFocusable(n)?n:this.digDown(n)},t.prototype._findChildWithMatchingIndexRange=function(i,n){if(!i.children)return null;var t=Object.keys(i.children).find(function(t){var e=i.children[t];return e.indexRange&&e.indexRange[0]<=n&&e.indexRange[1]>=n});return t?i.children[t]:void 0},t.prototype._findChildWithClosestIndex=function(e,t,i){if(void 0===i&&(i=null),!e.children)return null;var n=this.getNode(e.activeChild);if(i&&n&&n.index>=i[0]&&n.index<=i[1])return n;var r=Object.keys(e.children).map(function(t){return e.children[t].index});return this._findChildWithIndex(e,Closest(r,t))},t.prototype._findChildWithIndex=function(e,i){if(!e.children)return null;var t=Object.keys(e.children).find(function(t){return e.children[t].index===i});return t?e.children[t]:null},t.prototype._reindexChildrenOfNode=function(i){if(i.children){var t=Object.keys(i.children).map(function(t){return i.children[t]});return t.sort(function(t,e){return t.index-e.index}),i.children={},t.forEach(function(t,e){t.index=e+1,i.children[t.id]=t}),Set(this.tree,this.getPathForNodeId(i.id),i),i}},t.prototype.getNextChildInDirection=function(t,e){return e=e.toUpperCase(),"horizontal"===t.orientation&&"RIGHT"===e?this.getNextChild(t):"horizontal"===t.orientation&&"LEFT"===e?this.getPrevChild(t):"vertical"===t.orientation&&"DOWN"===e?this.getNextChild(t):"vertical"===t.orientation&&"UP"===e?this.getPrevChild(t):null},t.prototype.getNextChild=function(t){t.activeChild||(t.activeChild=this.getNodeFirstChild(t).id);var e=t.children[t.activeChild].index,i=this._findChildWithIndex(t,e+1);return i||(i=t.isWrapping?this.getNodeFirstChild(t):t.children[t.activeChild]),i},t.prototype.getPrevChild=function(t){t.activeChild||(t.activeChild=this.getNodeFirstChild(t).id);var e=t.children[t.activeChild].index,i=this._findChildWithIndex(t,e-1);return i||(i=t.isWrapping?this.getNodeLastChild(t):t.children[t.activeChild]),i},t.prototype.getNodeFirstChild=function(e){if(e.children){var t=Object.keys(e.children).map(function(t){return e.children[t].index}).sort();return this._findChildWithIndex(e,t[0])}},t.prototype.getNodeLastChild=function(e){if(e.children){var t=Object.keys(e.children).map(function(t){return e.children[t].index}).sort();return this._findChildWithIndex(e,t[t.length-1])}},t.prototype.handleKeyEvent=function(t){var e=t.keyCode?getDirectionForKeyCode(t.keyCode):t.direction.toUpperCase(),i=this.getNode(this.currentFocusNodeId);if("ENTER"===e&&i.onSelect)i.onSelect();else{var n=this.climbUp(i,e);if(n){this.isIndexAlignMode=!0===n.isIndexAlign;var r=this.getNextChildInDirection(n,e),o=r?this.digDown(r):this.digDown(n);return this.assignFocus(o.id),this.emitter.emit("move",{leave:i,enter:o,offset:"LEFT"===e||"UP"===e?-1:1}),i.onLeave&&i.onLeave(),o.onEnter&&o.onEnter(),o}}},t.prototype._setActiveChild=function(t,e){var i=this.getNode(e),n=this.getNode(t);if(i){if(n.activeChild&&n.activeChild!==i.id){var r=this.getNode(n.activeChild);n.activeChild=i.id,this.emitter.emit("inactive",r),this.emitter.emit("active",i)}n.parent&&this._setActiveChild(n.parent,n.id)}},t.prototype.assignFocus=function(t){var e=this.getNode(t);if(isFocusable(e)||(e=this.digDown(e)),!e)throw new Error("trying to assign focus to a non focusable node");this.currentFocusNodeId=e.id,e.indexRange?(this.currentFocusNodeIndex=e.indexRange[0],this.currentFocusNodeIndexRange=e.indexRange):this.currentFocusNodeIndex=e.index,e.parent&&this._setActiveChild(e.parent,e.id),e.onFocus&&e.onFocus(),this.emitter.emit("focus",e)},t}();module.exports=Lrud;